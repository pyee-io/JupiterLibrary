var JupiterDoc=function(){"use strict";const e=(e,t)=>Number(Math.round(e+"e"+t)+"e-"+t),t=e=>e?e.toLowerCase().replace(/[\s()]+/g,"_").replace(/_+$/,""):null;var a=e,n=(e,t)=>{var a=t.find((t=>t.name===e));return a?a.id:null},r=(e,t,a)=>{var n=a.find((t=>t.name===e));if(n)var r=n.fieldTypes.find((e=>e.name===t));return r?r.id:null},s=(e,t)=>{e.facts&&e.facts.forEach((e=>{const a=t.find((t=>t.id===e.factTypeId));a&&(e.factTypeName=a.name,e.allowMultiple=a.allowMultiple,e.fieldCount=a.fieldTypes.length),e.fields&&e.fields.forEach((a=>{const n=t.find((t=>t.id===e.factTypeId)).fieldTypes.find((e=>e.id===a.factFieldTypeId));n&&(a.factTypeFieldName=n.name,a.dataType=n.dataType)}))}))},i=(e,t,a,n)=>{const r=e.facts?e.facts.find((e=>e.factTypeId==t)):null;if(r){const e=r.fields.find((e=>e.factFieldTypeId==a));if(e)switch(n){case"date":return new luxon.DateTime.fromISO(e.dateValue);case"number":return e.numberValue;case"string":return e.stringValue;case"bool":return e.booleanValue;default:return null}}return null},o=(e,a)=>{const n=e.facts?e.facts.filter((e=>e.factTypeId===a)):null;if(!n)return null;const r=[];return n.forEach((e=>{const a={};if(a.id=e.id,!e.fields)return a;e.fields.forEach((e=>{var n=t(e.factTypeFieldName),r="";switch(e.dataType){case"Number":r=e.numberValue;break;case"Date":r=new luxon.DateTime.fromISO(e.dateValue);break;case"String":case"SelectList":r=e.stringValue;break;case"Boolean":r=e.booleanValue}a[n]=r})),r.push(a)})),r},m=(e,a)=>{const n=e.facts?e.facts.find((e=>e.factTypeId==a)):null;if(!n||!n.fields)return null;const r={};return r.fact_id=n.id,n.fields.forEach((e=>{var a=t(e.factTypeFieldName),n="";switch(e.dataType){case"Number":n=e.numberValue;break;case"Date":n=new luxon.DateTime.fromISO(e.dateValue);break;case"String":case"SelectList":n=e.stringValue;break;case"Boolean":n=e.booleanValue}n&&(r[a]=n)})),r},d=(e,t)=>e&&t?e.ts<t.ts?e:t:e||(t||null),l=(t,a,n)=>e(t*Math.pow(1+a,n),4),c=(t,a,n)=>e(t+t*a*n,4);return class{constructor(e,t,a=[],d=[]){this.cleanDoc(e),s(e,t),this.rawDoc=e,this.id=e.id,this.name=e.name;var l=a.find((t=>t.id===e.documentTypeId));this.document_type=l?l.name:null,this.agreement_id=i(e,n("Agreement ID",t),r("Agreement ID","Agreement ID",t),"string"),this.project_id=i(e,n("Project ID",t),r("Project ID","Project ID",t),"string"),this.project_name=i(e,n("Project Name",t),r("Project Name","Project Name",t),"string"),this.grantor=o(e,n("Grantor/Lessor",t)),this.effective_date=i(e,n("Effective Date",t),r("Effective Date","Effective Date",t),"date"),this.amendment_date=i(e,n("Amendment Date",t),r("Amendment Date","Amendment Date",t),"date"),this.leased_acres=i(e,n("Leased Acres",t),r("Leased Acres","Leased Acres",t),"number"),this.full_purchase_price=i(e,n("Full Purchase Price",t),r("Full Purchase Price","Full Purchase Price",t),"number"),this.closing_date=i(e,n("Closing Date",t),r("Closing Date","Closing Date",t),"date"),this.operational_details=m(e,n("Operational Details",t)),this.agreement_terms=o(e,n("Agreement Term",t)),this.periodic_payment_models=o(e,n("Periodic Payment Model",t)),this.one_time_payment_models=o(e,n("One Time Payment Model",t)),this.tags=this.getTags(d),this.review_status=i(e,n("Review Status",t),r("Review Status","Review Status",t),"string"),this.review_status_notes=i(e,n("Review Status",t),r("Review Status","Notes",t),"string"),this.agreement_id=this.calcAgreementId(),this.calcAgreementTermDates(this.agreement_terms,this.effective_date,this.operational_details)}calcAgreementId(){return this.grantor[0]&&"Complete"!==!this.review_status&&this.project_id&&this.project_name&&this.document_type&&!this.amendment_date?`${this.document_type} - ${this.project_name} - ${this.nicknameGrantor(this.grantor[0]["grantor/lessor_name"])} - ${this.project_id}`:null}getTags(e){var t=[];return this.rawDoc.tagIds.forEach((a=>{e.find((e=>e.id===a))&&t.push(e.find((e=>e.id===a)).name)})),t}calcAgreementTermDates(e,t,a){t&&(a=a||{},e.sort(((e,t)=>e.term_ordinal-t.term_ordinal)).forEach(((n,r)=>{if("Construction"===n.term_type&&!n.extension&&a.construction_commencement?n.start_date=a.construction_commencement:"Operations"===n.term_type&&!n.extension&&a.operations_commencement?n.start_date=a.operations_commencement:n.start_date=e[r-1]?e[r-1].end_date.plus({days:1}):t,n.start_date_text=n.start_date.toFormat("MM/dd/yyyy"),n.end_date=d(a.termination,n.start_date.plus({years:n.term_length_years}).plus({days:-1})),"Construction"!==n.term_type&&"Operations"!==n.term_type){var s=d(a.construction_commencement,a.operations_commencement);s&&(n.start_date.ts>=s.ts?n.cancelled_by_ops=!0:n.end_date.ts>=s.ts&&(n.end_date=s.plus({days:-1})))}else"Construction"===n.term_type&&a.operations_commencement&&n.end_date.ts>=a.operations_commencement.ts&&(n.end_date=a.operations_commencement.plus({days:-1}));n.end_date_text=n.end_date.toFormat("MM/dd/yyyy"),n.previous_escalation_periods=e.filter((e=>e.term_ordinal<n.term_ordinal&&e.payment_model===n.payment_model)).reduce(((e,t)=>e+t.term_length_years),0),n.previous_terms=e.filter((e=>e.term_ordinal<n.term_ordinal&&e.payment_model===n.payment_model)).length})))}periodicBasePayment(e,t,a,n,r,s,i){if(!e)return 0;t||(t={mw:0,inverter_count:0,inverter_rating_mvas:0});var o=Math.max(e.minimum_payment??0,(e.payment_per_mw??0)*(t.mw??0),(t.inverter_count??0)*(t.inverter_rating_mvas??0)*(e.payment_per_mva??0),e.flat_payment_amount??0,(e.payment_per_acre??0)*(i??0));return o+=(r??0)*s??0,o=a?l(o,(n??0)/100,s??0):c(o,(n??0)/100,s??0)}termPaymentModel(e,t){if(!t||0===t.length)return null;const a=e.payment_model??e.term_type;return a?t.find((e=>e.model_type===a)):t[0]}calcPaymentPeriodEnd(e,t,a,n){var r;return a?"Annually"===t?r=new luxon.DateTime.local(e.year,12,31):"Quarterly"===t?r=new luxon.DateTime.local(e.year,e.month+3,1).minus({days:1}):"Monthly"===t&&(r=new luxon.DateTime.local(e.year,e.month,1).plus({months:1}).minus({days:1})):"Annually"===t?r=e.plus({years:1}).minus({days:1}):"Quarterly"===t?r=e.plus({months:3}).minus({days:1}):"Monthly"===t&&(r=e.plus({months:1}).minus({days:1})),r>n?n:r}calcPeriodicPaymentsForTerm(e,t,n,r,s,i){if(e.cancelled_by_ops||0===s.length)return null;const o=[],m=this.termPaymentModel(e,n),d=this.periodicBasePayment(m,t,e.compounding_escalation,e.escalation_rate,e.escalation_amount,e.previous_terms,r);if(!m||!e.start_date||!e.end_date)return null;var c,_,p,u=0,y=e.term_payment_delay_days??0,h=e.start_date.plus({days:e.term_payment_delay_days}),f=m.periodic_escalation_rate??0;switch(e.first_payment_start){case"Start with Term (plus applicable lag)":_=e.start_date.plus({days:y});break;case"Start next Jan 1 after Term commencement":_=new luxon.DateTime.local(e.start_date.year+1,1,1).plus({days:y});break;case"Start 1st of month after commencement":_=new luxon.DateTime.local(h.year,h.month,1).plus({months:1});break;default:_=e.first_payment_date??e.start_date}for(;h<e.end_date;){if(!(p=this.calcPaymentPeriodEnd(_,m.payment_frequency,m.prorated_first_period,e.end_date)))return;var g;"Annually"===m.payment_frequency?c=a(p.plus({days:1}).diff(h,"years").years,4):"Quarterly"===m.payment_frequency?c=a(p.plus({days:1}).diff(h,"quarters").quarters,4):"Monthly"===m.payment_frequency&&(c=a(p.plus({days:1}).diff(h,"months").months,4));var v={Annually:1,Quarterly:4,Monthly:12};g=m.payment_frequency&&m.periodic_escalation_frequency?v[m.payment_frequency]/v[m.periodic_escalation_frequency]:1,s.forEach((t=>{o.push({project_id:i,payment_index:u,payee:this.nicknameGrantor(t["grantor/lessor_name"]),payment_date:_.toLocaleString(),grace_days:0===u?e.first_payment_grace_days??0:e.subsequent_payment_grace_days??0,payment_period_start:h.toLocaleString(),payment_period_end:p.toLocaleString(),prorata_factor:c,applicable_to_purchase:m.applicable_to_purchase,total_payment_amount:l(d*((t.payment_split??100)/100),f/100,Math.floor(u/g))*c})})),h=p.plus({days:1}),_=p.plus({days:1}),u++}return o.sort(((e,t)=>e.payment_date-t.payment_date)),o}calcAllTermPayments(){this.agreement_terms.forEach((e=>{this.periodic_payment_models&&(e.periodic_payments=this.calcPeriodicPaymentsForTerm(e,this.operational_details,this.amended_periodic_payment_models??this.periodic_payment_models,this.amended_leased_acres??this.leased_acres,this.grantor,this.project_id))}))}calcOneTimePayments(){if(!(!this.one_time_payment_models.length>0||!this.agreement_terms.length>0)){var e=[];this.one_time_payment_models.forEach((t=>{var a=t.payment_date??this.effective_date;e.push({payment_date:a.toLocaleString(),payment_type:t.payment_type,payment_amount:t.payment_amount,applicable_to_purchase:t.applicable_to_purchase,refundable:t.refundable})}));var t=e.filter((e=>e.applicable_to_purchase)).reduce(((e,t)=>e+t.payment_amount),0);this.agreement_terms.forEach((e=>{e.periodic_payments&&(t+=e.periodic_payments.filter((e=>e.applicable_to_purchase)).reduce(((e,t)=>e+t.total_payment_amount),0)??0)})),this.full_purchase_price>0&&e.push({payment_date:this.closing_date?this.closing_date.toLocaleString():this.agreement_terms.sort(((e,t)=>t.end_date-e.end_date))[0].end_date.toLocaleString(),payment_type:"Purchase Price",payment_amount:this.full_purchase_price-t,applicable_to_purchase:!0,refundable:!1}),this.one_time_payments=e}}processAmendments(e){const t=e.filter((e=>this.agreement_id&&e.agreement_id===this.agreement_id&&e.amendment_date&&e.id!==this.id));t&&(t.sort(((e,t)=>new Date(e.amendment_date)-new Date(t.amendment_date))).map((e=>e.amendment_ordinal=t.indexOf(e)+1)),t.forEach((e=>{e.leased_acres&&e.leased_acres!==this.leased_acres&&(this.amended_leased_acres=e.leased_acres),e.agreement_terms&&e.agreement_terms.length>0&&(this.amended_agreement_terms=e.agreement_terms),e.periodic_payment_models&&e.periodic_payment_models.length>0&&(this.amended_periodic_payment_models=e.periodic_payment_models)})),this.agreement_terms&&this.calcAllTermPayments())}nicknameGrantor(e){var t=[];if(e.toLowerCase().indexOf(" and ")>0&&t.push(e.toLowerCase().indexOf(" and ")),e.toLowerCase().indexOf(", ")>0&&t.push(e.toLowerCase().indexOf(",")),0===t.length)return e;var a=Math.min(...t);return e.substring(0,a)}cleanDoc(e){return["archivedBy","archivedOn","highlightedText","pageManipulationStatus","processingStatus","pages","securityLabelId","sourceDocumentId","sourceDocumentName","pageCount","thoughts","userIds"].forEach((t=>{delete e[t]})),e}}}();
