var JupiterDoc=function(){"use strict";const e=(e,t)=>Number(Math.round(e+"e"+t)+"e-"+t),t=e=>e?e.toLowerCase().replace(/[\s()]+/g,"_").replace(/_+$/,""):null;var a=e,r=(e,t)=>{var a=t.find((t=>t.name===e));return a?a.id:null},s=(e,t,a)=>{var r=a.find((t=>t.name===e));if(r)var s=r.fieldTypes.find((e=>e.name===t));return s?s.id:null},n=(e,t)=>{e.facts&&e.facts.forEach((e=>{const a=t.find((t=>t.id===e.factTypeId));a&&(e.factTypeName=a.name,e.allowMultiple=a.allowMultiple,e.fieldCount=a.fieldTypes.length),e.fields&&e.fields.forEach((a=>{const r=t.find((t=>t.id===e.factTypeId)).fieldTypes.find((e=>e.id===a.factFieldTypeId));r&&(a.factTypeFieldName=r.name,a.dataType=r.dataType)}))}))},i=(e,t,a,r)=>{const s=e.facts?e.facts.find((e=>e.factTypeId==t)):null;if(s){const e=s.fields.find((e=>e.factFieldTypeId==a));if(e)switch(r){case"date":return new luxon.DateTime.fromISO(e.dateValue);case"number":return e.numberValue;case"string":return e.stringValue;case"bool":return e.booleanValue;default:return null}}return null},o=(e,a)=>{const r=e.facts?e.facts.filter((e=>e.factTypeId===a)):null;if(!r)return[];const s=[];return r.forEach((e=>{const a={};if(a.id=e.id,!e.fields)return a;e.fields.forEach((e=>{var r=t(e.factTypeFieldName),s="";switch(e.dataType){case"Number":s=e.numberValue;break;case"Date":s=new luxon.DateTime.fromISO(e.dateValue);break;case"String":case"SelectList":s=e.stringValue;break;case"Boolean":s=e.booleanValue}a[r]=s})),s.push(a)})),s},d=(t,a,r)=>e(t*Math.pow(1+a,r),4),l=(t,a,r)=>e(t+t*a*r,4);return class{constructor(e,t,a=[],d=[]){this.cleanDoc(e),n(e,t),this.rawDoc=e,this.id=e.id,this.name=e.name;var l=a.find((t=>t.id===e.documentTypeId));this.document_type=l?l.name:null,this.project_id=i(e,r("Project ID",t),s("Project ID","Project ID",t),"string"),this.project_name=i(e,r("Project Name",t),s("Project Name","Project Name",t),"string"),this.grantor=i(e,r("Grantor/Lessor",t),s("Grantor/Lessor","Grantor/Lessor Name",t),"string"),this.effective_date=i(e,r("Effective Date",t),s("Effective Date","Effective Date",t),"date"),this.leased_acres=i(e,r("Leased Acres",t),s("Leased Acres","Leased Acres",t),"number"),this.lease_terms=o(e,r("Lease Term",t)),this.periodic_payment_models=o(e,r("Periodic Payment Model",t)),this.tags=this.getTags(d),this.review_status=i(e,r("Review Status",t),s("Review Status","Review Status",t),"string"),this.review_status_notes=i(e,r("Review Status",t),s("Review Status","Notes",t),"string"),this.calcLeaseTermDates(this.lease_terms,this.effective_date),this.lease_terms.forEach((e=>{this.calcPeriodicPayments(e,this.periodic_payment_models,this.leased_acres)}))}getTags(e){var t=[];return this.rawDoc.tagIds.forEach((a=>{e.find((e=>e.id===a))&&t.push(e.find((e=>e.id===a)).name)})),t}calcLeaseTermDates(e,t){t&&e.sort(((e,t)=>e.term_ordinal-t.term_ordinal)).forEach(((a,r)=>{a.start_date=e[r-1]?e[r-1].end_date.plus({days:1}):t,a.start_date_text=a.start_date.toFormat("M/d/yyyy"),a.end_date=a.start_date.plus({years:a.term_length_years}).plus({days:-1}),a.end_date_text=a.end_date.toFormat("M/d/yyyy"),a.previous_periods=e.filter((e=>e.term_ordinal<a.term_ordinal&&e.payment_model===a.payment_model)).reduce(((e,t)=>e+t.term_length_years),0),a.previous_terms=e.filter((e=>e.term_ordinal<a.term_ordinal&&e.payment_model===a.payment_model)).length}))}periodicBasePayment(e,t,a,r,s,n){if(!e)return 0;var i=Math.max(e.minimum_payment??0,(e.payment_per_mw??0)*(e.mw??0),(e.inverter_count??0)*(e.inverter_rating_mvas??0)*(e.payment_per_mva??0),e.flat_payment_amount??0,(e.payment_per_acre??0)*(n??0));return i+=(r??0)*s??0,i=t?d(i,a??0,s??0):l(i,a??0,s??0)}termPaymentModel(e,t){if(!t||0===t.length)return null;const a=e.payment_model??e.term_type;return a?t.find((e=>e.model_type===a)):t[0]}calcPeriodicPayments(e,t,r){const s=[],n=this.termPaymentModel(e,t),i=this.periodicBasePayment(n,e.compounding_escalation,e.escalation_rate,e.escalation_amount,e.previous_terms,r);if(!n||!e.start_date||!e.end_date)return null;var o;switch(e.first_payment_start){case"Start with Term (plus applicable lag)":default:o=e.start_date;break;case"Start next Jan 1 after Term commencement":var l=e.start_date.year;o=new luxon.DateTime.local(l+1,1,1)}var c,m,_,u=e.start_date,p=0,y=e.escalation_rate??0,f=n.periodic_escalation_rate??0;for(n.prorated_first_period&&0===p&&(m=new luxon.DateTime.local(o.year,12,31),c=a(m.plus({days:1}).diff(u,"years").years,2),_=0===p?e.first_payment_lag_days??0:0,s.push({payment_index:p,payment_date:o.plus({days:_}).toLocaleString(),payment_period_start:u.toLocaleString(),payment_period_end:m.toLocaleString(),prorata_years:c,base_payment:i,total_payment_amount:d(i,f,p+e.previous_periods)*c}),o=new luxon.DateTime.local(o.year+1,1,1),p++);o<e.end_date;)m=(m=n.prorated_first_period?new luxon.DateTime.local(o.year,12,31):o.plus({years:1}).minus({days:1}))>e.end_date?e.end_date:m,c=a(m.plus({days:1}).diff(o,"years").years,4),_=0===p?e.first_payment_lag_days??0:0,s.push({payment_index:p,payment_date:o.plus({days:_}).toLocaleString(),payment_period_start:o.toLocaleString(),payment_period_end:m.toLocaleString(),prorata_years:c,base_payment:a(i*(1+y/100),4),total_payment_amount:d(i,f,p+e.previous_periods)*c}),o=m.plus({days:1}),p++;s.sort(((e,t)=>e.payment_date-t.payment_date)),e.payments=s,e.cumulative_payment_amount=s.reduce(((e,t)=>e+t.total_payment_amount),0)}cleanDoc(e){return["archivedBy","archivedOn","highlightedText","pageManipulationStatus","processingStatus","pages","securityLabelId","sourceDocumentId","sourceDocumentName","pageCount","thoughts","userIds"].forEach((t=>{delete e[t]})),e}}}();
