var JupiterDoc=function(){"use strict";const e=e=>e.toLowerCase().replace(/[\s()]+/g,"_").replace(/_+$/,"");var t=(e,t)=>{var a=t.find((t=>t.name===e));return a?a.id:null},a=(e,t,a)=>{var r=a.find((t=>t.name===e));if(r)var s=r.fieldTypes.find((e=>e.name===t));return s?s.id:null},r=(e,t)=>{e.facts&&e.facts.forEach((e=>{const a=t.find((t=>t.id===e.factTypeId));a&&(e.factTypeName=a.name,e.allowMultiple=a.allowMultiple,e.fieldCount=a.fieldTypes.length),e.fields&&e.fields.forEach((a=>{const r=t.find((t=>t.id===e.factTypeId)).fieldTypes.find((e=>e.id===a.factFieldTypeId));r&&(a.factTypeFieldName=r.name,a.dataType=r.dataType)}))}))},s=(e,t,a,r)=>{const s=e.facts?e.facts.find((e=>e.factTypeId==t)):null;if(s){const e=s.fields.find((e=>e.factFieldTypeId==a));if(e)switch(r){case"date":return new luxon.DateTime.fromISO(e.dateValue);case"number":return e.numberValue;case"string":return e.stringValue;case"bool":return e.booleanValue;default:return null}}return null},n=(t,a)=>{const r=t.facts?t.facts.filter((e=>e.factTypeId===a)):null;if(!r)return[];const s=[];return r.forEach((t=>{const a={};if(a.id=t.id,!t.fields)return a;t.fields.forEach((t=>{var r=e(t.factTypeFieldName),s="";switch(t.dataType){case"Number":s=t.numberValue;break;case"Date":s=new luxon.DateTime.fromISO(t.dateValue);break;case"String":case"SelectList":s=t.stringValue;break;case"Boolean":s=t.booleanValue}a[r]=s})),s.push(a)})),s};return class{constructor(e,i,d=[],o=[]){this.cleanDoc(e),r(e,i),this.rawDoc=e,this.id=e.id,this.name=e.name;var l=d.find((t=>t.id===e.documentTypeId));this.document_type=l?l.name:null,this.project_id=s(e,t("Project ID",i),a("Project ID","Project ID",i),"string"),this.project_name=s(e,t("Project Name",i),a("Project Name","Project Name",i),"string"),this.grantor=s(e,t("Grantor/Lessor",i),a("Grantor/Lessor","Grantor/Lessor Name",i),"string"),this.effective_date=s(e,t("Effective Date",i),a("Effective Date","Effective Date",i),"date"),this.lease_terms=n(e,t("Lease Term",i)),this.periodic_payment_models=n(e,t("Periodic Payment Model",i)),this.tags=this.getTags(o),this.review_status=s(e,t("Review Status",i),a("Review Status","Review Status",i),"string"),this.review_status_notes=s(e,t("Review Status",i),a("Review Status","Notes",i),"string"),this.calcLeaseTermDates(this.lease_terms,this.effective_date),this.lease_terms.forEach((e=>{this.calcPeriodicPayments(e,this.periodic_payment_models)}))}getTags(e){var t=[];return this.rawDoc.tagIds.forEach((a=>{e.find((e=>e.id===a))&&t.push(e.find((e=>e.id===a)).name)})),t}calcLeaseTermDates(e,t){e.sort(((e,t)=>e.term_ordinal-t.term_ordinal)).forEach(((a,r)=>{a.start_date=e[r-1]?e[r-1].end_date.plus({days:1}):t,a.start_date_text=a.start_date.toFormat("M/d/yyyy"),a.end_date=a.start_date.plus({years:a.term_length_years}).plus({days:-1}),a.end_date_text=a.end_date.toFormat("M/d/yyyy"),a.previous_periods=e.filter((e=>e.term_ordinal<a.term_ordinal&&e.payment_model===a.payment_model)).reduce(((e,t)=>e+t.term_length_years),0)}))}periodicBasePayment(e){return e?Math.max(e.minimum_payment??0,(e.payment_per_mw??0)*(e.mw??0),(e.inverter_count??0)*(e.inverter_rating_mvas??0)*(e.payment_per_mva??0),e.flat_payment_amount??0,(e.payment_per_acre??0)*(e.leased_acres??0)):0}termPaymentModel(e,t){if(!t||0===t.length)return null;const a=e.payment_model??e.term_type;return a?t.find((e=>e.model_type===a)):t[0]}calcPeriodicPayments(e,t){const a=[],r=this.termPaymentModel(e,t),s=this.periodicBasePayment(r);if(!r)return null;var n,i,d=r.first_payment_date??e.start_date,o=e.start_date,l=0,_=e.escalation_rate??0,c=r.periodic_escalation_rate??0;for(r.prorated_first_period&&0===l&&(n=+(i=new luxon.DateTime.local(r.first_payment_date?r.first_payment_date.year:e.start_date.year,12,31)).plus({days:1}).diff(o,"years").years.toFixed(2),a.push({payment_index:l,payment_date:r.first_payment_date?r.first_payment_date.toLocaleString():e.start_date.plus({days:r.first_payment_due_days_after_term_start??0}).toLocaleString(),payment_period_start:o.toLocaleString(),payment_period_end:i.toLocaleString(),prorata_years:n,base_payment:+(s*(1+_/100)).toFixed(2),total_payment_amount:+(s*(1+_*(e.term_ordinal-1)/100)*(1+c*(l+e.previous_periods)/100)*n).toFixed(2)}),d=new luxon.DateTime.local(d.year+1,1,1),l++);d<e.end_date;)n=+(i=(i=r.prorated_first_period?new luxon.DateTime.local(d.year,12,31):d.plus({years:1}).minus({days:1}))>e.end_date?e.end_date:i).plus({days:1}).diff(d,"years").years.toFixed(2),a.push({payment_index:l,payment_date:d.plus({days:0===l?r.first_payment_due_days_after_term_start??0:0}).toLocaleString(),payment_period_start:d.toLocaleString(),payment_period_end:i.toLocaleString(),prorata_years:n,base_payment:+(s*(1+_/100)).toFixed(2),total_payment_amount:+(s*(1+_*(e.term_ordinal-1)/100)*(1+c*(l+e.previous_periods)/100)*n).toFixed(2)}),d=i.plus({days:1}),l++;a.sort(((e,t)=>e.payment_date-t.payment_date)),e.payments=a,e.cumulative_payment_amount=a.reduce(((e,t)=>e+t.total_payment_amount),0)}cleanDoc(e){return["archivedBy","archivedOn","highlightedText","pageManipulationStatus","processingStatus","pages","securityLabelId","sourceDocumentId","sourceDocumentName","pageCount","thoughts","userIds"].forEach((t=>{delete e[t]})),e}}}();
